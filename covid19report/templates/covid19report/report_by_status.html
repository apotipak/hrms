{% extends "page_covid_report.html" %}

{% load i18n %}
{% block title %} {{ page_title}} - {% trans 'Covid-19 Report' %} {% endblock %}
{% load static %}
{% load widget_tweaks %}

{% block content %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper pt-2">

    <!-- Main content -->
    <section class="content">

      <div class="card-header" style="padding: 0 2px 10px 0;">        
        <h5 class="card-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;<b>รายงานการฉีดวัคซีนแยกตามสถานะ</b>&nbsp;&nbsp;</h5>
        <br>
        <div class="float-right pb-1">
          <div class="d-flex flex-row-reverse">
            
            <!--<button class="btn btn-outline-success btn-md" onclick="export_to_excel()">&nbsp;<i class="fas fa-print fa-sm"></i>&nbsp;&nbsp;Print</button>-->

            <!--
                <button class="btn btn-outline-info btn-sm dropdown-toggle" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fas fa-print fa-sm"></i>&nbsp;&nbsp;Print
                </button>                
            -->
          </div>
        </div>
      </div>

      <div class="col-12 p-0 pt-2">

        <form method="post" autocomplete="off" name="search_form">
          {% csrf_token %}
          
          <div class="card-body p-0 pt-2">
            <div class="form-group">


              <div class="input-group col-6 offset-3">
        
                <div class="input-group-prepend"><span class="input-group-text border-bottom-0 rounded-0" style="background-color: #d2d4d6; width:165px;"><b>สถานะการฉีดวัคซีน</b></span></div>
                <select id="id_get_vaccine_status_option" name="get_vaccine_status_option" class="form-control form-control-md" style="border-radius: 0; width: 100px;">
                    <option value="0">เลือกสถานะการฉีดวัคซีน</option>
                    <option value="1">นัดหมายเพื่อฉีดวัคซีนข็มที่ 1</option>
                    <option value="2">ได้รับการฉีดวัคซีนเข็มที่ 1 เรียบร้อยแล้ว</option>
                    <option value="3">นัดหมายเพื่อฉีดวัคซีนข็มที่ 2</option>
                    <option value="4">ได้รับการฉีดวัคซีนเข็มที่ 2 เรียบร้อยแล้ว</option>
                </select>
                &nbsp;&nbsp;
                <a href="javascript:SearchFormSubmit();" class="btn btn-secondary" role="button"><i class="fas fa-search fa-sm"></i>&nbsp;&nbsp;ค้นหา</a>                
              </div>


            </div>
          </div>

        </form>        

        <div class="card">
            
            <div class="card-header d-flex">
              <h3 class="card-title">&nbsp;</h3>
              <ul class="nav nav-pills ml-auto">                
                <li class="nav-item">
                  <a class="btn btn-sm btn-outline-secondary" href="#" onclick="export_to_excel();"><i class="far fa-file-excel"></i>&nbsp;&nbsp;Export to Excel</a>                
                </li>
              </ul>
            </div>

            <div class="card-body">

              <div>
                <table class="table table-striped dataTable" id="employee_list_table">
                    <thead class="bg-secondary">
                      <tr>
                        <th scope="col">รหัส</th>
                        <th scope="col">ชื่อ</th>
                        <th scope="col">เบอร์โทร</th>
                        <th scope="col">สถานะการฉีดวัคซีน</th>
                        <th scope="col">วันที่ฉีดวัคซีน</th>
                        <th scope="col">สถานที่</th>
                        <th scope="col" class="text-center">ไฟล์แนบ</th>
                        <th scope="col" class='d-none'>ไฟล์แนบ</th>
                        <th scope="col" class="text-center"><i class="fas fa-sm fa-download"></i></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td class='d-none'>&nbsp;</td>
                        <td>&nbsp;</td>
                      </tr>
                    </tbody>
                  </table>
            
              </div>
              <!-- /.tab-content -->

            </div><!-- /.card-body -->
          </div>
          <!-- ./card -->
        

      </div>
      <!-- /.col -->

      </div>
    

    </section>
    <!-- /.content -->




{% endblock %}



{% block javascript %}
<script>

var table = $('#employee_list_table').DataTable({
    "paging": true,
    "pageLength": 15,
    "scrollCollapse": true,
    "lengthChange": false,
    "searching": true,
    "ordering": true,
    "info": false,
    "autoWidth": true,
    "language": {
        search: '<i class="fa fa-filter" aria-hidden="true"></i>',
        searchPlaceholder: 'Filter data'
    },
    "columnDefs": [
        {
        "targets": [2,3,4,5,6,7,8],
        "orderable": false
        }    
    ],  
    "dom": 'Brtip',
    buttons: [
        {
            extend: 'print',
            title: '',
            exportOptions: {
            columns: [ 0,1,2,3,4,5,7]
            }
        },
        {
            extend: 'excelHtml5',        
            title: '',
            exportOptions: {
            columns: [ 0,1,2,3,4,5,7]
            }
        },
    ]
});
table.buttons('.buttons-print').nodes().css("display", "none");
table.buttons('.buttons-excel').nodes().css("display", "none");
table.buttons('.buttons-pdf').nodes().css("display", "none");

$(document).ready( function () {
    /*
    $('#id_emp_id').keyup(function(e){
        if(e.keyCode == 13) {
            e.preventDefault();
            //$("#id_get_vaccine_status_option").focus();
            return false;
        }
    });
    */

    $(window).keydown(function(event){
        if(event.keyCode == 13) {
            event.preventDefault();
            return false;
        }
    });
});

function print_document() {
  var contract_number_from = $("#id_contract_number_from").val();
  var contract_number_to = $("#id_contract_number_to").val();
  var start_date = $("#id_start_date").val();
  var end_date = $("#id_end_date").val();

  console.log(contract_number_from + "," + contract_number_to + "," + start_date + "," + end_date);
  if(contract_number_from=="") {
    $.alert({
        title: 'Error',
        type: 'red',
        content: "กรุณาป้อนรหัสสัญญา",
        animation: 'zoom',
        animationBounce: 1.5,
        closeIcon: false,
        boxWidth: '38%',
        useBootstrap: false,
    });    
    return false;
  }

  if(contract_number_to=="") {
    $.alert({
        title: 'Error',
        type: 'red',
        content: "กรุณาป้อนรหัสสัญญา",
        animation: 'zoom',
        animationBounce: 1.5,
        closeIcon: false,
        boxWidth: '38%',
        useBootstrap: false,
    });    
    return false;
  }

  var href = "/reports/cms/gpm-403-daily-guard-performance-by-contract/" + contract_number_from + "/" + contract_number_to + "/" + start_date + "/" + end_date + "/";
  window.open(href,'_blank');
}
 
function export_to_excel() {
  var contract_number_from = $("#id_contract_number_from").val();
  var contract_number_to = $("#id_contract_number_to").val();
  var start_date = $("#id_start_date").val();
  var end_date = $("#id_end_date").val();

  var href = "/reports/cms/export-gpm-403-daily-guard-performance-by-contract-to-excel/" + contract_number_from + "/" + contract_number_to + "/" + start_date + "/" + end_date + "/";
  window.open(href,'_blank');    
}

function showLoading() {
  $.LoadingOverlaySetup({
      background      : "rgba(0, 0, 0, 0.5)",
      image           : "/static/img/logo-small.png",        
      imageAnimation  : "1.5s fadein",
      imageColor      : "#ffcc00"
  });
  $.LoadingOverlay("show"); 
}




  function SearchFormSubmit() {        
    var get_vaccine_status_option = $('#id_get_vaccine_status_option').val();

    if(get_vaccine_status_option=="0") {
        $(document).Toasts('create', {
          class: "bg-danger", 
          title: "{% trans 'Error' %}",
          subtitle: '',
          autohide: true,
          delay: 2000,
          body: "กรุณาเลือกสถานะการฉีดวัคซีน",
          autoDismiss: true,
          close: true,
          autoremove: true,
        });
        $("#id_get_vaccine_status_option").focus();
        return false;    
    }

    //alert(emp_id + "," + get_vaccine_status_option);
    //return false;

    showLoading();

    $.ajax({
      url: "/reports/covid-19/ajax-report-by-status/",
      type: "POST",
      dataType: 'json',
      async: true,      
      data: {
        csrfmiddlewaretoken: '{{ csrf_token }}',
        get_vaccine_status_option: get_vaccine_status_option,
      },
      success : function(data) {              
        if(data.is_error) {
            $.alert({
                title: 'Error',
                type: 'red',
                content: "ไม่พบข้อมูล",
                animation: 'zoom',
                animationBounce: 1.5,
                closeIcon: false,
                boxWidth: '38%',
                useBootstrap: false,
            });
            $("#id_search_result").hide();
        } else {
            result = "";
            for(i=0;i<data.employee_list.length;i++) {
                
                result += "<tr>";
                result += "<td>" + data.employee_list[i]['emp_id'] + "</td>";
                result += "<td nowrap>" + data.employee_list[i]['full_name'] + "</td>";                          
                result += "<td nowrap>" + data.employee_list[i]['phone_number'] + "</td>";
                result += "<td nowrap>" + data.employee_list[i]['get_vaccine_status_option_text'] + "</td>";

                result += "<td>" + data.employee_list[i]['get_vaccine_date'] + "</td>";
                result += "<td>" + data.employee_list[i]['get_vaccine_place'] + "</td>";

                if(data.employee_list[i]['file_attach']!="") {
                    result += "<td class='text-center'><i class='fas fa-xs fa-check text-success'></i></td>";
                    result += "<td class='d-none'>Y</td>";
                } else {
                    result += "<td class='text-center'><i class='fas fa-xs fa-times text-danger'></i></td>";
                    result += "<td class='d-none'>N</td>";
                }                

                

                result += "<td class='text-center' nowrap>";
                result += " <a href='#' onclick='edit_item(" + data.employee_list[i]['emp_id'] + ")'>&nbsp;&nbsp;<small>PDF</small>&nbsp;&nbsp;</a>";
                result += "</tr>";          
            }
        
            table.destroy();
            $('#employee_list_table tbody').empty().append(result);        
            table = $('#employee_list_table').DataTable({
                "paging": true,
                "pageLength": 15,
                "scrollCollapse": true,
                "lengthChange": false,
                "searching": true,
                "ordering": true,
                "info": false,
                "autoWidth": true,
                "language": {
                    search: '<i class="fa fa-filter" aria-hidden="true"></i>',
                    searchPlaceholder: 'Filter data'
                },
                "columnDefs": [
                    {
                    "targets": [2,3,4,5,6,7,8],
                    "orderable": false
                    }    
                ],  
                "dom": 'Brtip',
                buttons: [
                    {
                        extend: 'print',
                        title: 'รายงานการฉีดวัคซีนโควิด-19 - แยกตามสถานะ',
                        exportOptions: {
                        columns: [ 0,1,2,3,4,5,7]
                        }
                    },
                    {
                        extend: 'excelHtml5',        
                        title: 'รายงานการฉีดวัคซีนโควิด-19 - แยกตามสถานะ',
                        exportOptions: {
                        columns: [ 0,1,2,3,4,5,7]
                        }
                    },
                ]
            });
            table.buttons('.buttons-print').nodes().css("display", "none");
            table.buttons('.buttons-excel').nodes().css("display", "none");
            table.buttons('.buttons-pdf').nodes().css("display", "none");
        }

        $.LoadingOverlay("hide");
        
      }
    });
  }  

    function export_to_excel() {
        $(".buttons-excel").trigger("click");  
    }

  </script>
{% endblock %}  