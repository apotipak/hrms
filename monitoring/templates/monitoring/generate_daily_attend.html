{% extends "page_generic.html" %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}
{% block title %}{{ page_title}} - Generate Daily Attend{% endblock %}
{% load static %}

{% block content %}
 	<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
	
		<div class="content-header">
			<div class="col-6 offset-3">

			</div>
		</div>

    	<!-- Main content -->
    	<section class="content col-6 offset-3">

			<div class="card card-outline card-success" id="generate_date_card">
			  <div class="card-header">
			    <h3 class="card-title lead"><i class="fas fa-cog"></i>&nbsp;&nbsp;Generate Daily Attend</h3>
			    <div class="card-tools">
			 		<button type="button" class="btn btn-tool" data-card-widget="maximize"><i class="fas fa-expand"></i></button>
			      	<button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i></button>
			      	<!--<span class="badge badge-primary">Label</span>-->
			    </div>
			    <!-- /.card-tools -->

			  </div>
			  <!-- /.card-header -->
			  <div class="card-body">

				<form>
				{% csrf_token %}
				  <div class="form-row align-items-center">
				    <div class="col-auto form-inline">
				      <label for="inlineFormInput">Date</label>&nbsp;&nbsp;
				      <input type="text" class="form-control mb-2" id="id_generated_date" placeholder="dd/mm/yyyy">
				    </div>
				    <div class="col-auto">
				      <button type="button" id="generated_date_ok_button" class="btn btn-primary mb-2">&nbsp;&nbsp;OK&nbsp;&nbsp;</button>&nbsp;
				      <button type="reset" class="btn btn-secondary mb-2">Cancel</button>
				    </div>
				  </div>
				</form>

			  </div>
			  <!-- /.card-body -->
			  <div class="card-footer">
			  	<div id="generate_status">
			  		<progress id="progress-bar" value="0" max="100" style="display:none; margin-bottom: 1em;"></progress>			  		
			  	</div>
			  </div>
			  <!-- /.card-footer -->

			    <!--
				<div id="test" class="overlay">
					<i class="fas fa-2x fa-sync-alt fa-spin"></i>
				</div>
				-->
			</div>
			<!-- /.card -->

    	</section>
	</div>
{% endblock %}


{% block javascript %}
<script>
$(document).ready(function(){	
	$('#generate_date_card').removeClass('overlay');

	$('#id_generated_date').focus();
	$('#id_generated_date').datepicker({format: 'dd/mm/yyyy', altField: '#thealtdate', altFormat: 'dd/mm/yyyy', autoclose: true}).datepicker("setDate", new Date());
});

$("#generated_date_ok_button").click( function() {
	event.preventDefault();    	

	var frm = $('#process-raw-data');
    var pgrbar = $('#progress-bar');

	var generated_date = $("#id_generated_date").val();
	//alert(generated_date);

	$.ajax({
    	url : "/monitoring/ajax/sp_generate_daily_attend/",
    	type : "POST",
    	data : {          
      		csrfmiddlewaretoken: '{{ csrf_token }}',
      		generated_date: generated_date,
    	},
		beforeSend: function () {
			//$('#generate_date_card').addClass('overlay');
		},
    	success: function(data) {
    		/*
    		var count = data.com_type.length;
    		var result = "";
    		for(var i=0; i<count; i++) {
				result += "<p>" + data.com_type[i]; + "</p>";
    		}
    		$("#generate_status").html(result);
    		$('#generate_date_card').removeClass('overlay');
    		*/
    		alert("Success");

    	},
    });

});

function get_generate_daily_attend_status(generated_date) {
        $.ajax({
            type: 'get',
            url: '/monitoring/ajax/sp_generate_daily_attend_status/',
            data: {'generated_date': generated_date},
            success: function (data) {
                frm.html('');
                if (data.state == 'PENDING') {
                    frm.html('Please wait...');
                }
                else if (data.state == 'PROGRESS') {
                    pgrbar.css('display', 'inline');
                    pgrbar.val(data.result.percent);
                    frm.html('lines processed ' + data.result.current + ' out of ' + data.result.total);
                }
                else if(data.state == 'SUCCESS'){
                    pgrbar.css('display', 'none');
                    frm.html('Successfully Completed!');

                }
                if (data.state != 'SUCCESS') {
                    setTimeout(function () {
                        get_task_info(task_id)
                    }, 500);
                }
            },
            error: function (data) {
                frm.html("error!");
            }
        });
    }

</script>
{% endblock %}
		
