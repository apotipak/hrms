{% extends "page_generic.html" %}
{% load i18n %}
{% load static %}
{% load widget_tweaks %}
{% block title %}{{ page_title}} - Daily Attendance{% endblock %}
{% load static %}

{% block content %}
 	<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
	
		<div class="content-header">
			<div class="col-6 offset-3">

			</div>
		</div>

    	<!-- Main content -->
    	<section class="content">

    		<!-- SEARCH FORM -->
			<div class="card card-outline card-default" id="daily_attendance_search_card">

			  <div class="card-body">
				<form class="form-inline" name="daily_attendance_search_form">
					{% csrf_token %}

			  	<div class="row col-12">

			  		<div class="float-left text-left col-5">
					    <div class="form-inline">
					        <label class="control-label">Date</label>&nbsp;&nbsp;				        
					        <input type="text" class="form-control form-control-sm" id="id_date" placeholder="dd/mm/yyyy">&nbsp;&nbsp;
					    	<label class="control-label">Shift</label>&nbsp;&nbsp;
					        <select id="id_shift_option" class="form-control form-control-sm">
							  <option value="0">---------</option>
							  <option value="1" selected="">A | All</option>
							  <option value="2">D | Day shift</option>
							  <option value="3">N | Night shift</option>
					        </select>					        
					    </div>
					</div>

					<div class="float-right text-right col-7">
					    <div class="form-group">
		                      <input class="form-check-input" type="radio" name="searchOptions" id="id_search_by_cnt_id" value="1" checked>
		                      <label class="control-label" for="id_search_by_cnt_id">Contract No</label>&nbsp;
		                      <input type="number" min=0 id="id_cus_id" class="form-control form-control-sm col-2" value="0002526">&nbsp;
		                      <input type="number" min=0 id="id_cus_brn" class="form-control form-control-sm col-1" value="000">&nbsp;
		                      <input type="number" min=0 id="id_cus_vol" class="form-control form-control-sm col-1" value="001">&nbsp;&nbsp;&nbsp;
		                      <input class="form-check-input" type="radio" name="searchOptions" id="id_search_by_empid" value="2" readonly>
		                      <label class="control-label" for="id_search_by_empid">Employee ID</label>&nbsp;
		                      <input type="text" id="id_emp_id" class="form-control form-control-sm col-2" readonly>
	                    </div>
	                </div>

				</div>
				</form>
			  </div>
			  <!-- /.card-body -->

			  <!--
			  <div class="card-footer">
			  	&nbsp;
			  </div>
			  -->
			  <!-- /.card-footer -->
			</div>
			<!-- /.card -->




			<!-- DATA ENTRY FORM -->
			<div class="card card-outline card-secondary" id="daily_attendance_data_entry_card">

			  <!--
			  <div class="card-header">
			    <div class="card-tools">
			    	<button id="save_button" type="button" class="btn btn-success btn-sm"><i class="fas fa-plus fa-sm"></i>&nbsp;&nbsp;{% trans 'Add' %}</button>&nbsp;&nbsp;|&nbsp;&nbsp;
		        	<button id="save_button" type="button" class="btn btn-primary btn-sm"><i class="fas fa-save fa-sm"></i>&nbsp;&nbsp;{% trans 'Save' %}</button>
		        	<button id="delete_button" type="button" class="btn btn-danger btn-sm"><i class="fas fa-trash fa-sm"></i>&nbsp;&nbsp;{% trans 'Delete' %}</button>
			    </div>	
			  </div>
			  -->

			  <div class="card-body">
				<form class="form-inline" name="daily_attendance_form">
					{% csrf_token %}
				</form>

				<!-- Tab Header -->
		        <div class="clearfix">
		          <div class="float-left">
		            <ul class="nav nav-tabs navbar-expand nav-fill" id="customer" role="tablist">

		              <li class="nav-item active">
		                <a class="nav-link active" id="tab1-tab" data-toggle="tab" href="#tab1" role="tab" aria-controls="tab1">{% trans 'Attendance Information' %}</a>
		              </li>

		              <li class="nav-item">
		                <a class="nav-link" id="tab2-tab" data-toggle="tab" href="#tab2" role="tab" aria-controls="tab2">{% trans 'Contract/Schedule Information' %}</a>
		              </li>

		            </ul>        
		          </div>
		        </div>


		        <!-- Tab Body -->
		        <div class="tab-content" id="dailyAttendanceBodyTab">
		            <div class="tab-pane fade show active pt-2" id="tab1" role="tabpanel" aria-labelledby="tab1-tab">

		            	<div id="id_schedule_option"></div>

		            	<div id="id_employee_list">
							<!--<table id="employee_list_table" class="table table-sm">-->
							<font size='2em;'>
							<table id='employee_list_table' class='table table-sm table-fixed table-condensed table-wrapper-scroll-y my-custom-scrollbar'>
							  <thead>
							    <tr>
							      <th scope="col">&nbsp;</th>
							      <th scope="col">Emp ID</th>
							      <th scope="col">Name</th>
							      <th scope="col">Rank</th>
							      <th scope="col">Shift</th>
							      <th scope="col">Late</th>
							      <th scope="col">Full</th>
							      <th scope="col">Relief</th>
							      <th scope="col">Rel. ID</th>
							      <th scope="col">Name</th>
							      <th scope="col">TEL</th>
							      <th scope="col">Call Time</th>
							    </tr>
							  </thead>
							  <tbody>
							    <tr>
							      <td colspan="12" class="text-center"><br><br>There is no data.<br><br><br></td>
							    </tr>
							  </tbody>
							</table>
							</font>
						</div>

		        	</div>

		            <div class="tab-pane fade show" id="tab2" role="tabpanel" aria-labelledby="tab2-tab">
		            	TODO
		        	</div>

		        </div>



			  </div>
			  <!-- /.card-body -->

			  <!--
			  <div class="card-footer">
			  	&nbsp;
			  </div>
			  -->

			  <!-- /.card-footer -->

			  <!--
			  <div id="test" class="overlay">
				<i class="fas fa-2x fa-sync-alt fa-spin"></i>
			  </div>
			  -->
			</div>
			<!-- /.card -->



    		<!-- EMPLOYEE DETAIL -->
			<div class="card card-outline card-success">
			  <div class="card-header">
			    
			    <!--<h3 class="card-title"><i class="fas fa-tasks"></i>&nbsp;&nbsp;<b>Daily Attendance</b></h3>-->

			    <div class="card-tools">
					<button id="save_button" type="button" class="btn btn-success btn-sm"><i class="fas fa-plus fa-sm"></i>&nbsp;&nbsp;{% trans 'Add' %}</button>&nbsp;&nbsp;|&nbsp;&nbsp;
		        	<button id="save_button" type="button" class="btn btn-primary btn-sm"><i class="fas fa-save fa-sm"></i>&nbsp;&nbsp;{% trans 'Save' %}</button>
		        	<button id="delete_button" type="button" class="btn btn-danger btn-sm"><i class="fas fa-trash fa-sm"></i>&nbsp;&nbsp;{% trans 'Delete' %}</button>			      	
			    </div>
			    <!-- /.card-tools -->

			  </div>

			  <!-- /.card-header -->
			  <div class="card-body">

			  	<div class="row col-12">
					
					<form class="form-row">
					{% csrf_token %}

			  		<!--
			  		<div class="float-left text-left col-5">
					    <div class="form-inline">
					        <label class="control-label">Employee ID</label>&nbsp;&nbsp;				        
					        <input type="number" min=0 class="form-control form-control-sm col-3" id="id_emp_id">&nbsp;&nbsp;
					        <input type="number" min=0 class="form-control form-control-sm col-2" id="id_emp_name">&nbsp;
					    </div>
					</div>
					-->

				    <div class="col-3">
				    	<label class="text-align-top text-align-left"><b>Employee ID</b></label>
                        <div class="input-group">                            	
                          	<input type="number" id="id_emp_id" name="id_emp_id" class="form-control form-control-sm" value="" />
                          	<button id="emp_id_lookup_button" type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal" data-url=""><i class="fas fa-search fa-sm"></i></button>
                        </div>
				    </div>	 


					<div class="col-6">
						<label class="control-label" for="id_emp_id"><b>Name</b></label>
					    <div class="input-group">
		                      <input type="text" id="id_emp_name_th" class="form-control form-control-sm col-2">&nbsp;
		                      <input type="text" id="id_emp_rank" class="form-control form-control-sm col-1">&nbsp;
		                      <input type="text" id="id_emp_dept" class="form-control form-control-sm col-1">&nbsp;&nbsp;&nbsp;
	                    </div>
	                </div>

	                <!--
				    <div class="float-left col-3">
				    	<label class="" for="id_emp_name_th"><b>Name</b></label>
				      	<input type="text" class="form-control form-control-sm" id="id_emp_name_th" placeholder="" readonly />
				    </div>

				    <div class="float-left col-2">
				    	<label class="" for="id_sch_rank"><b>Rank</b></label>
				      	<input type="text" class="form-control form-control-sm" id="id_sch_rank" placeholder="" readonly />
				    </div>

				    <div class="float-right col-2">
				    	<label class="" for="id_sch_rank"><b>Department</b></label>
				      	<input type="text" class="form-control form-control-sm" id="id_sch_dept" placeholder="" readonly />
				    </div>
					-->

					<!--
					<div class="float-right text-right col-7">
					    <div class="form-group">
		                      <input class="form-check-input" type="radio" name="searchOptions" id="id_search_by_cnt_id" value="1" checked>
		                      <label class="control-label" for="id_search_by_cnt_id">Contract No</label>&nbsp;
		                      <input type="number" min=0 id="id_cus_id" class="col-2" value="0001420">&nbsp;
		                      <input type="number" min=0 id="id_cus_brn" class="col-1" value="000">&nbsp;
		                      <input type="number" min=0 id="id_cus_vol" class="col-1" value="001">&nbsp;&nbsp;&nbsp;
		                      <input class="form-check-input" type="radio" name="searchOptions" id="id_search_by_empid" value="2" readonly>
		                      <label class="control-label" for="id_search_by_empid">Employee ID</label>&nbsp;
		                      <input type="text" id="id_emp_id" class="col-2" readonly>
	                    </div>
	                </div>
	            	-->

					    <!--
					    <div class="form-group">
					      <button type="button" id="generated_date_ok_button" class="btn btn-primary btn-sm">&nbsp;&nbsp;&nbsp;&nbsp;OK&nbsp;&nbsp;&nbsp;&nbsp;</button>&nbsp;
					      <button type="reset" class="btn btn-secondary btn-sm">Cancel</button>
					    </div>
					    -->
				</div>
				</form>
			  </div>
			  <!-- /.card-body -->

			  <!--
			  <div class="card-footer">
			  	&nbsp;
			  </div>
			  -->
			  <!-- /.card-footer -->

			</div>
			<!-- /.card -->



    	</section>
	</div>
{% endblock %}

{% block javascript %}
<script>

	$('#id_cus_id').focus();


	$(document).on('click', '#employee_list_table tbody tr', function(row, $el, field) {
		$(this).addClass('highlight').siblings().removeClass('highlight');
		var emp_id = $(this).find('td:eq(1)').text();
		

		/*
		var service_id = $(this).find('td:eq(0)').text();	
		var srv_eff_from = $(this).find('td:eq(5)').text();
		var srv_eff_to = $(this).find('td:eq(6)').text();

		$('#id_selected_service_id').val(service_id);
		$('#id_duration_from').datepicker('setDate', srv_eff_from);
		$("#chkDurationFromDisable").prop("checked", true);		
		$('#id_duration_to').datepicker('setDate', srv_eff_to);
		$("#chkDurationToDisable").prop("checked", true);
		*/
		
	});

	$(document).on('keyup keypress', '#daily_attendance_search_form input[type="text"]', function(e) {
		if(e.which == 13) {
			e.preventDefault();
			return false;
	    }
	});

    $(document).on('keypress', '#id_cus_id', function(e) {
      if(e.which == 13) {      
        e.preventDefault();

        var obj = $(this);
      	var id_cus_id = obj.val();

      	if(id_cus_id!=0) {
	      	while (id_cus_id.length < 7)
	        	id_cus_id = "0" + id_cus_id;
	      	$('#id_cus_id').val(id_cus_id);

	        $('#id_cus_brn').focus();
      	} else {
      		$(this).focus();
      	}

      }
    });

    $(document).on('keypress', '#id_cus_brn', function(e) {
      if(e.which == 13) {      
        e.preventDefault();

      	var obj = $(this);
      	var id_cus_brn = obj.val();

      	while (id_cus_brn.length < 3) 
        	id_cus_brn = "0" + id_cus_brn;
      	
      	$('#id_cus_brn').val(id_cus_brn);

        $('#id_cus_vol').focus();

      }
    });


    /* ID_CUS_VOL */
    $(document).on('keypress', '#id_cus_vol', function(e) {
      if(e.which == 13) { 
      	
      	showLoading();

        e.preventDefault();
        
        //alert("todo1");
    	var obj = $(this);
      	var id_cus_vol = obj.val();
      	while (id_cus_vol.length < 3) 
        	id_cus_vol = "0" + id_cus_vol;

        $('#id_cus_vol').val(id_cus_vol);

        var attendance_date = $('#id_date').val();
      	var cus_id = $('#id_cus_id').val();
      	var cus_brn = $('#id_cus_brn').val();
      	var cus_vol = $('#id_cus_vol').val();

		$.ajax({
			url : "/monitoring/ajax/get_attendance_information/",
			type : "POST",
			data : {          
		  		csrfmiddlewaretoken: '{{ csrf_token }}',
		  		attendance_date: attendance_date,
		  		cus_id: cus_id,
		  		cus_brn: cus_brn,
		  		cus_vol: cus_vol,
			},
			success : function(data) {

				if(data.is_found) {

					// Get Schedule list info
					result = "";
					schedule_list_length = data.schedule_list.length;
					for(i=0; i<schedule_list_length; i++) {
						result += data.schedule_list[i];
					}

					// TODO
					//$('#id_schedule_option').text(result);
					$('#id_schedule_option').text("");

					// Get Employee info
					result = "";
					result += "<font size='2em;'>";
					result += "<table id='employee_list_table' class='table table-sm table-fixed table-condensed table-wrapper-scroll-y my-custom-scrollbar'>";
					result += "  <thead>";
					result += "    <tr>";
					result += "      <th scope='col'>&nbsp;</th>";
					result += "      <th scope='col'>Emp ID</th>";
					result += "      <th scope='col'>Name</th>";
					result += "      <th scope='col'>Rank</th>";
					result += "      <th scope='col'>Shift</th>";
					result += "      <th scope='col'>Late</th>";
					result += "      <th scope='col'>Full</th>";
					result += "      <th scope='col'>Relief</th>";
					result += "      <th scope='col'>Rel. ID</th>";
					result += "      <th scope='col'>Name</th>";
					result += "      <th scope='col'>TEL</th>";
					result += "      <th scope='col'>Call Time</th>";
					result += "    </tr>";
					result += "  </thead>";
					result += "  <tbody class='sortable'>";


					if(data.employee_list.length>0) {
						for(i=0; i<data.employee_list.length; i++) {
							emp_id = data.employee_list[i]["emp_id"];
							emp_fname_th = data.employee_list[i]["emp_fname_th"];
							emp_lname_th = data.employee_list[i]["emp_lname_th"];
							sch_rank = data.employee_list[i]["sch_rank"];
							shf_desc = data.employee_list[i]["shf_desc"];
							absent = data.employee_list[i]["absent"];

							result += "    <tr>";

							if(absent==1) {
								result += "	     <td><font class='text-danger'>X</font></td>";
							} else {
								result += "	     <td>&nbsp</td>";
							}
							
							result += "	     <td>" + emp_id + "</td>";
							result += "	     <td>" + emp_fname_th + "&nbsp;&nbsp;" + emp_lname_th + "</td>";
							result += "	     <td>" + sch_rank + "</td>";
							result += "	     <td>" + shf_desc + "</td>";
							result += "	     <td>Late</td>";
							result += "	     <td>Full</td>";
							result += "	     <td>Relief</td>";
							result += "	     <td>Rel.ID</td>";
							result += "	     <td>Name</td>";
							result += "	     <td>TEL</td>";
							result += "	     <td>Call Time</td>";
							result += "    </tr>";
						}
					}
					else {
							result += "    <tr class='text-center'>";
							result += "	     <td colspan='12'><br><br>There is no data....<br><br><br></td>";
							result += "	   </tr>"
					}
					result += "  </tbody>";
					result += "</table>";
					result += "</font>";

					$('#id_employee_list').html(result);

				} else {
					$.alert({
					    title: 'Error',
					    type: 'red',
					    content: "<strong><h4>" + attendance_date + "</strong><small> is not generated. Please generate first.</small></h4>",
					    animation: 'zoom',
					    animationBounce: 1.5,
					    closeIcon: false,
					    boxWidth: '38%',
					    useBootstrap: false,
					});					
				}
			}
		});

		$.LoadingOverlay("hide");
      	
      }
    });





    $(document).on('keypress', '#id_emp_id', function(e) {
      if(e.which == 13) {      
        e.preventDefault();
        alert("todo2");
      }
    });

	$('#id_date').datepicker({format: 'dd/mm/yyyy', altField: '#thealtdate', altFormat: 'dd/mm/yyyy', autoclose: true}).datepicker("setDate", new Date());
	
	$("input:radio[name='searchOptions']").change(function(){
		var _val = $(this).val();
		if(_val==1) {
			// Search by Contract ID
			$("#id_cus_id").focus();		
			$("#id_cus_id").attr("readonly", false);
			$("#id_cus_brn").attr("readonly", false);
			$("#id_cus_vol").attr("readonly", false);

			$("#id_emp_id").attr("readonly", true);
		} else {
			// Search by Employee ID
			$("#id_emp_id").focus();
			$("#id_emp_id").attr("readonly", false);
			$("#id_cus_id").attr("readonly", true);
			$("#id_cus_brn").attr("readonly", true);
			$("#id_cus_vol").attr("readonly", true);
		}
	});


	function showLoading() {
		$.LoadingOverlaySetup({
		    background      : "rgba(0, 0, 0, 0.5)",
		    image           : "/static/img/logo-small.png",
		    imageAnimation  : "1.5s fadein",
		    imageColor      : "#ffcc00"
		});
		$.LoadingOverlay("show");	
	}

</script>
{% endblock %}
		
